<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Todayâ€™s Tasks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">

  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --checklist: #22c55e;
      --delegation: #fbbf24;
      --done: #16a34a;
      --btn: #1f2937;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, system-ui, sans-serif;
      background: radial-gradient(circle at top, #020617, #020617 70%);
      color: var(--text);
    }

    .container {
      max-width: 720px;
      margin: auto;
      padding: 20px;
    }

    h1 {
      margin: 0;
      font-size: 1.4rem;
    }

    .sub {
      color: var(--muted);
      font-size: 0.85rem;
      margin-bottom: 16px;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .badge {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 600;
      white-space: nowrap;
    }

    .checklist { color: var(--checklist); background: rgba(34,197,94,.12); }
    .delegation { color: var(--delegation); background: rgba(251,191,36,.12); }

    .task {
      flex: 1;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .time {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 4px;
    }

    button {
      background: var(--btn);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    button.done {
      background: rgba(22,163,74,.15);
      color: var(--done);
      border-color: rgba(22,163,74,.4);
      cursor: default;
    }

    button:disabled {
      opacity: 0.7;
      cursor: default;
    }

    .empty {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
  </style>
</head>
<nav style="
  display:flex;
  gap:18px;
  padding:14px 18px;
  border-bottom:1px solid #1f2937;
  background:#020617;
  position:sticky;
  top:0;
  z-index:10;
">
  <a href="index.html" style="color:#94a3b8;text-decoration:none;">Tasks</a>
  <a href="habits.html" style="color:#94a3b8;text-decoration:none;">Habits</a>
  <a href="proofs.html" style="color:#e5e7eb;text-decoration:none;font-weight:600;">
    Proofs
  </a>
</nav>

<body>
<div class="container">
  <h1>Todayâ€™s Tasks</h1>
  <div class="sub" id="today"></div>

  <div id="tasks">Loadingâ€¦</div>
</div>

<script>
  const WORKER_URL = "https://entirenewwrker.rkknitfabsachin.workers.dev/";
  const USER_EMAIL = "rkknitfabsachin@gmail.com";

  document.getElementById("today").textContent =
    new Date().toLocaleDateString(undefined, {
      weekday: "long",
      day: "numeric",
      month: "long"
    });

  fetchTasks();

  function fetchTasks() {
    fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "getTodayTasks",
        email: USER_EMAIL
      })
    })
    .then(r => r.json())
    .then(renderTasks)
    .catch(() => {
      document.getElementById("tasks").innerHTML =
        "<div class='empty'>Failed to load tasks</div>";
    });
  }

  function renderTasks(data) {
    const wrap = document.getElementById("tasks");

    if (!data.success || !data.tasks || data.tasks.length === 0) {
      wrap.innerHTML = "<div class='empty'>No tasks for today ðŸŽ‰</div>";
      return;
    }

    wrap.innerHTML = "";

    data.tasks.forEach(t => {
      const card = document.createElement("div");
      card.className = "card";

      const badge = document.createElement("div");
      badge.className = "badge " + t.source;
      badge.textContent = t.source.toUpperCase();

      const body = document.createElement("div");
      body.className = "task";
      body.textContent = t.task;

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = new Date(t.planned).toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      });

      body.appendChild(time);

      const btn = document.createElement("button");
      btn.textContent = "Mark Done";

      btn.onclick = () => markDone(t, btn);

      card.appendChild(badge);
      card.appendChild(body);
      card.appendChild(btn);
      wrap.appendChild(card);
    });
  }

  function markDone(task, btn) {
    btn.disabled = true;
    btn.textContent = "Savingâ€¦";

    const payload = {
      action: "markTaskDone",
      email: USER_EMAIL,
      source: task.source,
      taskRef: task.task
    };

    if (task.source === "checklist") {
      payload.planned =
        new Date(task.planned).toISOString().slice(0, 10);
    }

    if (task.taskId) {
      payload.taskId = task.taskId;
    }

    fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        btn.textContent = "Done âœ“";
        btn.classList.add("done");
      } else {
        btn.textContent = "Error";
        btn.disabled = false;
        console.error(res);
      }
    })
    .catch(() => {
      btn.textContent = "Error";
      btn.disabled = false;
    });
  }
</script>
</body>
</html>
